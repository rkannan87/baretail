@startuml
!theme plain
title D&D Document Storage - Option 1 Metadata Flag Controlled Retention

participant "D&D System" as DD
participant "BOB Service\n(Clustered)" as BOB
participant "Simple Storage (SS)" as SS
participant "Hard Hat Container\n(EPM Folder)" as Container
participant "Metadata Store" as Metadata
participant "Retention Policy\nEngine" as Policy

note over DD, Policy : OPTION 1: IMMEDIATE STORAGE WITH METADATA FLAG CONTROL

== Document Upload Phase ==
DD -> BOB : Upload D&D document (no BID available)
BOB -> BOB : Generate EPM code for folder naming
BOB -> Container : Check/Create folder named after EPM code

BOB -> SS : PUT /repositories/{repo-id}/documents/{document-id}
note right : Upload with metadata flag\nfor short retention period

SS -> Container : Store document in EPM folder
SS -> Metadata : Store document metadata + retention flag
Metadata --> SS : Metadata stored with exception flag
SS --> BOB : Upload confirmation + document reference
BOB --> DD : Return document reference (immediate)

note over SS, Policy : Document stored with exceptional\nretention policy flag active

== Retention Policy Application ==
Policy -> Metadata : Check document retention requirements
alt Metadata flag exists (exceptional retention)
    Policy -> Policy : Apply short retention period
    note right : Metadata flag controls\ntemporary retention
else No metadata flag
    Policy -> Container : Apply folder-level retention policy
    note right : Fallback to folder-level\nretention policy
end

== BID Available - Metadata Update ==
DD -> BOB : BID becomes available
BOB -> SS : PUT /repositories/{repo-id}/documents/{document-id}
note right : Update metadata with BID\nand remove retention flag

SS -> Metadata : Update document metadata + remove flag
Metadata --> SS : Metadata updated, flag removed
SS --> BOB : Update confirmation
BOB --> DD : Metadata update complete

note over Policy : With flag removed, retention\nreverts to folder-level policy

== Retention Policy Execution ==
Policy -> Metadata : Periodic retention check
alt Short retention period expired (flag active)
    Policy -> SS : Purge document
    SS -> Container : Remove document from storage
    SS --> Policy : Document purged
else Folder-level retention (no flag)
    Policy -> Policy : Apply standard retention period
    note right : Standard business retention\nrules apply
end

== System Specifications ==
note over DD, Policy : TECHNICAL CONSTRAINTS & BENEFITS

note over SS #lightblue
**Simple Storage Limits:**
• Max document size: 101MB
• Max container size: 500TB (expandable to 2PB)
• Current Hard Hat container: No existing retention policies
end note

note over BOB #lightgreen
**Implementation Benefits:**
• No additional storage costs
• Programmable solution via API
• Lower system complexity
• Immediate document availability
end note

note over Policy #lightyellow
**Retention Policy Hierarchy:**
1. Metadata (flag) controlled retention (primary)
2. Folder-level retention policy (fallback)
3. Container-level policy (if folder not set)
end note

note over Container #lightcoral
**Folder Structure:**
• Hard Hat container
• EPM-code named folders
• Folder-level retention policies
• Flag-based exceptional retention
end note

@enduml
